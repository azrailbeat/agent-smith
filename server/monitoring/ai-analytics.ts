/**
 * –ò–ò-–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM –º–æ–¥–µ–ª–µ–π
 * –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Å –ø–æ–º–æ—â—å—é OpenAI
 */

import OpenAI from "openai";
import { ModelUsage, ServiceStatus, AIAnalysisRequest, AIAnalysisResponse } from "../types/monitoring";
import { logActivity } from "../activity-logger";

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è OpenAI API
const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// –¢–∏–ø—ã –∞–Ω–∞–ª–∏–∑–∞
export enum AnalysisType {
  OPTIMIZATION = "optimization",
  TRENDS = "trends",
  ALERTS = "alerts",
  COMPREHENSIVE = "comprehensive"
}

/**
 * –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM —Å –ø–æ–º–æ—â—å—é OpenAI
 * @param data –î–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
 * @param analysisType –¢–∏–ø –∞–Ω–∞–ª–∏–∑–∞
 * @param userId ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–ø—Ä–æ—Å–∏–≤—à–µ–≥–æ –∞–Ω–∞–ª–∏–∑
 */
export async function analyzeMonitoringData(
  data: { llmUsage: ModelUsage[]; llmStatus: ServiceStatus[] },
  analysisType: AnalysisType,
  userId?: number
): Promise<AIAnalysisResponse> {
  try {
    if (!process.env.OPENAI_API_KEY) {
      console.warn("OPENAI_API_KEY –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–µ–¥–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ LLM –¥–∞–Ω–Ω—ã—Ö.");
      return generateFallbackAnalysis(data, analysisType);
    }

    // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ OpenAI
    const { llmUsage, llmStatus } = data;
    
    // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∞–Ω–∞–ª–∏–∑–∞
    let systemPrompt = "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM –º–æ–¥–µ–ª–µ–π. ";
    let userPrompt = "";
    
    // –û–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–µ
    const monitoringData = JSON.stringify({
      llmModels: llmUsage.map(model => ({
        name: model.model,
        tokensUsed: model.tokensUsed,
        cost: model.cost,
        requestCount: model.requestCount,
        avgResponseTime: model.avgResponseTime
      })),
      services: llmStatus.map(service => ({
        name: service.serviceName,
        status: service.status,
        lastUpdated: service.lastUpdated,
        details: service.details
      }))
    });
    
    switch (analysisType) {
      case AnalysisType.OPTIMIZATION:
        systemPrompt += "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM –º–æ–¥–µ–ª–µ–π —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Å–Ω–∏–∂–µ–Ω–∏–µ –∑–∞—Ç—Ä–∞—Ç –∏ —É–ª—É—á—à–µ–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏.";
        userPrompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM –º–æ–¥–µ–ª–µ–π –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞—Ç—Ä–∞—Ç –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –û–±—Ä–∞—Ç–∏ –æ—Å–æ–±–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –º–æ–¥–µ–ª–∏ —Å –≤—ã—Å–æ–∫–∏–º–∏ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏ –∏ –º–µ–¥–ª–µ–Ω–Ω—ã–º –≤—Ä–µ–º–µ–Ω–µ–º –æ—Ç–≤–µ—Ç–∞. –î–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: ${monitoringData}`;
        break;
        
      case AnalysisType.TRENDS:
        systemPrompt += "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM –º–æ–¥–µ–ª–µ–π —Å –ø—Ä–æ–≥–Ω–æ–∑–∞–º–∏ –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏ –ø–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é.";
        userPrompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM –º–æ–¥–µ–ª–µ–π –∏ –≤—ã—è–≤–∏ —Ç–µ–∫—É—â–∏–µ —Ç—Ä–µ–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –°–¥–µ–ª–∞–π –ø—Ä–æ–≥–Ω–æ–∑ –±—É–¥—É—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏ –∑–∞—Ç—Ä–∞—Ç, –∞ —Ç–∞–∫–∂–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é. –î–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: ${monitoringData}`;
        break;
        
      case AnalysisType.ALERTS:
        systemPrompt += "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM –∏ –≤—ã—è–≤–∏ –ª—é–±—ã–µ –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏–ª–∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞ –≤ —Ä–∞–±–æ—Ç–µ —Å–µ—Ä–≤–∏—Å–æ–≤.";
        userPrompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM –º–æ–¥–µ–ª–µ–π –∏ –≤—ã—è–≤–∏ –≤—Å–µ –ø—Ä–æ–±–ª–µ–º—ã, –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –∏ –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–∑–∫–∏–µ –º–µ—Å—Ç–∞. –°–æ—Å—Ä–µ–¥–æ—Ç–æ—á—å—Å—è –Ω–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–∞—Ö, –≤—ã—Å–æ–∫–∏—Ö –∑–∞—Ç—Ä–∞—Ç–∞—Ö –∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏. –î–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: ${monitoringData}`;
        break;
        
      case AnalysisType.COMPREHENSIVE:
        systemPrompt += "–ü—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –≤—Å–µ—Ö –∞—Å–ø–µ–∫—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM –º–æ–¥–µ–ª–µ–π, –≤–∫–ª—é—á–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é, —Ç—Ä–µ–Ω–¥—ã –∏ –ø—Ä–æ–±–ª–µ–º—ã.";
        userPrompt = `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Å–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM –º–æ–¥–µ–ª–µ–π –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –≤–∫–ª—é—á–∞—é—â–∏–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∑–∞—Ç—Ä–∞—Ç, —Ç—Ä–µ–Ω–¥—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏. –î–∞–Ω–Ω—ã–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: ${monitoringData}`;
        break;
    }
    
    systemPrompt += " –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä—É–π –æ—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ markdown —Å —Ä–∞–∑–¥–µ–ª–∞–º–∏ –∏ –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏. –ë—É–¥—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º –∏ –ø—Ä–∏–≤–µ–¥–∏ —á–∏—Å–ª–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –≥–¥–µ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ.";
    
    // –ó–∞–ø—Ä–æ—Å –∫ OpenAI API
    // the newest OpenAI model is "gpt-4o" which was released May 13, 2024. do not change this unless explicitly requested by the user
    const response = await openai.chat.completions.create({
      model: "gpt-4o",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt }
      ],
      temperature: 0.2,
      max_tokens: 2000
    });
    
    const analysisContent = response.choices[0].message.content || "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö.";
    
    // –õ–æ–≥–∏—Ä—É–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
    await logActivity({
      action: "ai_analysis_completed",
      entityType: "monitoring",
      details: `AI –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM (—Ç–∏–ø: ${analysisType})`,
      userId: userId || 1, // –ò—Å–ø–æ–ª—å–∑—É–µ–º 1 –∫–∞–∫ fallback ID
      metadata: {
        analysisType,
        tokensUsed: response.usage?.total_tokens || 0,
        llmModelsCount: llmUsage.length,
        servicesCount: llmStatus.length
      }
    });
    
    return {
      success: true,
      analysisType,
      content: analysisContent,
      metadata: {
        tokensUsed: response.usage?.total_tokens || 0,
        modelUsed: "gpt-4o",
        timestamp: new Date().toISOString()
      }
    };
    
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM:", error);
    // –õ–æ–≥–∏—Ä—É–µ–º –æ—à–∏–±–∫—É
    await logActivity({
      action: "ai_analysis_error",
      entityType: "monitoring",
      details: `–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ LLM: ${error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`,
      userId: userId || 1
    });
    
    return {
      success: false,
      analysisType,
      content: "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ OpenAI API –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
      metadata: {
        error: error instanceof Error ? error.message : "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞",
        timestamp: new Date().toISOString()
      }
    };
  }
}

/**
 * –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –≤ —Å–ª—É—á–∞–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –∫–ª—é—á–∞ OpenAI API
 */
function generateFallbackAnalysis(
  data: { llmUsage: ModelUsage[]; llmStatus: ServiceStatus[] },
  analysisType: AnalysisType
): AIAnalysisResponse {
  const { llmUsage, llmStatus } = data;
  
  // –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏
  const totalRequests = llmUsage.reduce((sum, model) => sum + model.requestCount, 0);
  const totalTokens = llmUsage.reduce((sum, model) => sum + model.tokensUsed, 0);
  const totalCost = llmUsage.reduce((sum, model) => sum + model.cost, 0);
  const avgResponseTime = llmUsage.reduce((sum, model) => sum + model.avgResponseTime, 0) / (llmUsage.length || 1);
  
  // –ü—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
  const problemServices = llmStatus.filter(s => s.status !== 'healthy');
  
  // –ö–æ–Ω—Ç–µ–Ω—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∞–Ω–∞–ª–∏–∑–∞
  let content = "";
  
  switch (analysisType) {
    case AnalysisType.OPTIMIZATION:
      content = `
## –ê–Ω–∞–ª–∏–∑ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM –º–æ–¥–µ–ª–µ–π

### –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: ${totalRequests.toLocaleString()}
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: ${totalTokens.toLocaleString()}
- –û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã: $${totalCost.toFixed(2)}
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${avgResponseTime.toFixed(2)} —Å–µ–∫

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏**: –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞ –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á
2. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–æ–≤**: –°–æ–∫—Ä–∞—Ç–∏—Ç–µ —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í–Ω–µ–¥—Ä–∏—Ç–µ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –ú–æ–¥–µ–ª–∏ —Å –≤—ã—Å–æ–∫–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç—å—é
${llmUsage.sort((a, b) => b.cost - a.cost).slice(0, 3).map(model => 
  `- **${model.model}**: $${model.cost.toFixed(2)} (${model.tokensUsed.toLocaleString()} —Ç–æ–∫–µ–Ω–æ–≤)`
).join('\n')}

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –º–æ–¥–µ–ª—è–º —Å –≤—ã—Å–æ–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –æ—Ç–≤–µ—Ç–∞
- –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫—É –Ω–∞–≥—Ä—É–∑–∫–∏ –º–µ–∂–¥—É –º–æ–¥–µ–ª—è–º–∏
- –£–≤–µ–ª–∏—á—å—Ç–µ –ø—Ä–æ–ø—É—Å–∫–Ω—É—é —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–æ–≤ —Å –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π
      `;
      break;
      
    case AnalysisType.TRENDS:
      content = `
## –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM –º–æ–¥–µ–ª–µ–π

### –¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: ${totalRequests.toLocaleString()}
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: ${totalTokens.toLocaleString()}
- –û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã: $${totalCost.toFixed(2)}

### –ü—Ä–æ–≥–Ω–æ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- –ü—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–π –¥–∏–Ω–∞–º–∏–∫–∏, –æ–∂–∏–¥–∞–µ–º—ã–µ –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü: $${(totalCost * 1.15).toFixed(2)} (—Ä–æ—Å—Ç –Ω–∞ 15%)
- –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤: ${(totalTokens * 1.2).toLocaleString()} (—Ä–æ—Å—Ç –Ω–∞ 20%)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é
1. **–ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞**: –£–≤–µ–ª–∏—á—å—Ç–µ –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–∏ —Å –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–º —Ä–æ—Å—Ç–æ–º
2. **–ë—é–¥–∂–µ—Ç**: –ó–∞–ø–ª–∞–Ω–∏—Ä—É–π—Ç–µ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞ –Ω–∞ LLM —Å–µ—Ä–≤–∏—Å—ã
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –í–Ω–µ–¥—Ä–∏—Ç–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ —É–≤–µ–ª–∏—á–µ–Ω–∏–∏ –æ–±—ä–µ–º–∞

### –ù–∞–∏–±–æ–ª–µ–µ –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏
${llmUsage.sort((a, b) => b.requestCount - a.requestCount).slice(0, 3).map(model => 
  `- **${model.model}**: ${model.requestCount.toLocaleString()} –∑–∞–ø—Ä–æ—Å–æ–≤ (${(model.requestCount / totalRequests * 100).toFixed(1)}% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞)`
).join('\n')}
      `;
      break;
      
    case AnalysisType.ALERTS:
      content = `
## –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–æ–Ω –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

### –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤
${problemServices.length === 0 
  ? '‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ' 
  : problemServices.map(service => 
      `‚ö†Ô∏è **${service.serviceName}**: ${service.status === 'degraded' ? '–°–Ω–∏–∂–µ–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å' : '–°–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω'}
      - –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date(service.lastUpdated).toLocaleString()}
      ${service.details?.latestError ? `- –û—à–∏–±–∫–∞: ${service.details.latestError}` : ''}
      ${service.details?.queueLength ? `- –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏: ${service.details.queueLength} –∑–∞–ø—Ä–æ—Å–æ–≤` : ''}`
    ).join('\n\n')
}

### –ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
${llmUsage
  .filter(model => model.avgResponseTime > 2)
  .map(model => `üê¢ **${model.model}**: –í—ã—Å–æ–∫–æ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ (${model.avgResponseTime.toFixed(2)} —Å–µ–∫)`)
  .join('\n')}
${llmUsage.filter(model => model.avgResponseTime > 2).length === 0 ? '‚úÖ –í—Å–µ –º–æ–¥–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç—å—é –æ—Ç–≤–µ—Ç–∞' : ''}

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å–æ —Å—Ç–æ–∏–º–æ—Å—Ç—å—é
${llmUsage
  .filter(model => model.cost > 50)
  .map(model => `üí∞ **${model.model}**: –í—ã—Å–æ–∫–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã ($${model.cost.toFixed(2)})`)
  .join('\n')}
${llmUsage.filter(model => model.cost > 50).length === 0 ? '‚úÖ –ù–µ—Ç –º–æ–¥–µ–ª–µ–π —Å —á—Ä–µ–∑–º–µ—Ä–Ω–æ –≤—ã—Å–æ–∫–∏–º–∏ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏' : ''}

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. ${problemServices.length > 0 ? '–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã' : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Ä–∞–Ω–Ω–µ–≥–æ –≤—ã—è–≤–ª–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º'}
2. ${llmUsage.filter(model => model.avgResponseTime > 2).length > 0 ? '–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –º–æ–¥–µ–ª—è–º —Å –≤—ã—Å–æ–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –æ—Ç–≤–µ—Ç–∞' : '–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ —Ç–µ–∫—É—â—É—é –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤'}
3. ${llmUsage.filter(model => model.cost > 50).length > 0 ? '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∫–≤–æ—Ç –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–æ—Ä–æ–≥–∏—Ö –º–æ–¥–µ–ª–µ–π' : '–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞—Ç—Ä–∞—Ç—ã –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π'}
      `;
      break;
      
    case AnalysisType.COMPREHENSIVE:
      content = `
## –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è LLM –º–æ–¥–µ–ª–µ–π

### –û–±—â–∏–π –æ–±–∑–æ—Ä
- –í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤: ${totalRequests.toLocaleString()}
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ —Ç–æ–∫–µ–Ω–æ–≤: ${totalTokens.toLocaleString()}
- –û–±—â–∏–µ –∑–∞—Ç—Ä–∞—Ç—ã: $${totalCost.toFixed(2)}
- –°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: ${avgResponseTime.toFixed(2)} —Å–µ–∫
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–µ—Ä–≤–∏—Å–æ–≤: ${llmStatus.length}
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–æ–¥–µ–ª–µ–π: ${llmUsage.length}

### –°—Ç–∞—Ç—É—Å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
${problemServices.length === 0 
  ? '‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç –≤ —à—Ç–∞—Ç–Ω–æ–º —Ä–µ–∂–∏–º–µ' 
  : `‚ö†Ô∏è ${problemServices.length} –∏–∑ ${llmStatus.length} —Å–µ—Ä–≤–∏—Å–æ–≤ –∏–º–µ—é—Ç –ø—Ä–æ–±–ª–µ–º—ã`
}

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∑–∞—Ç—Ä–∞—Ç
1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –º–æ–¥–µ–ª–∏ —Å –≤—ã—Å–æ–∫–∏–º–∏ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏: ${llmUsage.filter(m => m.cost > 50).length > 0 ? '–î–∞' : '–ù–µ—Ç'}
2. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ –ø—Ä–æ–º–ø—Ç–æ–≤ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∑–∞–ø—Ä–æ—Å–æ–≤
3. –í–æ–∑–º–æ–∂–Ω–∞—è —ç–∫–æ–Ω–æ–º–∏—è –ø—Ä–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏: –¥–æ 25% ($${(totalCost * 0.25).toFixed(2)})

### –ê–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤
1. –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º—ã–π —Ä–æ—Å—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è: 15-20% –≤ –º–µ—Å—è—Ü
2. –ù–∞–∏–±–æ–ª–µ–µ –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏: ${llmUsage.sort((a, b) => b.requestCount - a.requestCount).slice(0, 2).map(m => m.model).join(', ')}
3. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è: ${totalRequests > 10000 ? '–í—ã—Å–æ–∫–∞—è' : '–°—Ä–µ–¥–Ω—è—è'}

### –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã
1. –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${llmUsage.filter(m => m.avgResponseTime > 2).length > 0 ? '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –º–æ–¥–µ–ª–∏ —Å –≤—ã—Å–æ–∫–∏–º –≤—Ä–µ–º–µ–Ω–µ–º –æ—Ç–≤–µ—Ç–∞' : '–ù–µ—Ç –ø—Ä–æ–±–ª–µ–º'}
2. –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å: ${problemServices.length > 0 ? '–ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã' : '–í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –¥–æ—Å—Ç—É–ø–Ω—ã'}
3. –°—Ç–æ–∏–º–æ—Å—Ç—å: ${llmUsage.filter(m => m.cost > 50).length > 0 ? '–û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –º–æ–¥–µ–ª–∏ —Å –≤—ã—Å–æ–∫–∏–º–∏ –∑–∞—Ç—Ä–∞—Ç–∞–º–∏' : '–ó–∞—Ç—Ä–∞—Ç—ã –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –Ω–æ—Ä–º—ã'}

### –ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏
1. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è**: –í–Ω–µ–¥—Ä–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—é –ø—Ä–æ–º–ø—Ç–æ–≤
2. **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä—É–µ–º–æ–º—É —Ä–æ—Å—Ç—É
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –£—Å–∏–ª–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
4. **–ë—é–¥–∂–µ—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü–µ—Ä–µ—Å–º–æ—Ç—Ä–µ—Ç—å –±—é–¥–∂–µ—Ç —Å —É—á–µ—Ç–æ–º —Ä–æ—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
      `;
      break;
  }
  
  return {
    success: true,
    analysisType,
    content,
    metadata: {
      generationMethod: "fallback",
      timestamp: new Date().toISOString()
    }
  };
}

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –∞–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
 * @param request –ó–∞–ø—Ä–æ—Å –Ω–∞ –∞–Ω–∞–ª–∏–∑
 */
export async function handleAnalysisRequest(request: AIAnalysisRequest): Promise<AIAnalysisResponse> {
  const { llmUsage, llmStatus, analysisType, userId } = request;
  
  return await analyzeMonitoringData(
    { llmUsage, llmStatus },
    analysisType,
    userId
  );
}